/*
Copyright(c) 2014 Michael Q. Rieck, Thomas A. Rieck
*/
Ext.define("BDC.lib.ButtonsPanel",{extend:"Ext.panel.Panel",alias:"widget.buttons-panel",layout:{type:"vbox",align:"center"},columnWidth:0.2,height:350,title:"Options",padding:"10px",items:[{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Step the machine"},text:"STEP",focusCls:"",id:"stepButton",iconCls:"step-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Save the machine state"},text:"SAVE",disabled:true,focusCls:"",id:"saveButton",iconCls:"save-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.1},{xtype:"button",tooltip:{text:"Load program to the machine"},text:"LOAD",focusCls:"",id:"loadButton",iconCls:"load-icon",iconAlign:"top",width:"80%",flex:0.6,menu:{items:[{text:"Multiply x and y",id:"programOne",iconCls:"tape-icon"},{text:"Divide x by y",id:"programTwo",iconCls:"tape-icon"},{text:"Add numbers from x up to y",id:"programThree",iconCls:"tape-icon"},{text:"Generate Fibonacci numbers",id:"programFour",iconCls:"tape-icon"},{text:"Compute base-2 Logarithm of x",id:"programFive",iconCls:"tape-icon"},{text:"Add data in array",id:"programSix",iconCls:"tape-icon"}]}},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Reset the machine"},text:"RESET",focusCls:"",id:"resetButton",iconCls:"reset-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Launch Assembler Editor"},text:"ASSEMBLER",focusCls:"",id:"assemblerButton",iconCls:"assemble-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2}]});Ext.define("BDC.lib.MemoryPanel",{extend:"Ext.panel.Panel",alias:"widget.memory-panel",title:"Main Memory",uses:["BDC.lib.Colors","BDC.lib.DigitValidator"],columnWidth:0.6,height:350,layout:{type:"table",columns:11},padding:"10px",keyPress:function(b,a){b.setRawValue("")},initComponent:function(){var b,a;this.callParent(arguments);for(b=0;b<11;++b){if(b===0){this.add({border:false})}else{this.add({baseCls:"memory-col-header",html:""+(b-1),padding:"10 5 7 11"})}}for(b=0,a=0;b<100;++b){if(b%10===0){this.add({baseCls:"memory-row-header",html:""+a++,padding:"0 15 0 10"})}this.add({xtype:"textfield",minLength:1,maxLength:1,fieldCls:"memory-cell",selectOnFocus:true,emptyText:"0",width:25,itemId:"memory-cell-"+b,vtype:"digit",enableKeyEvents:true,listeners:{keypress:this.keyPress},margin:"2px"})}},getMemoryCells:function(){return this.query("textfield[itemId^=memory-cell]")},clear:function(){var a=this.getMemoryCells();Ext.each(a,function(b){b.reset();b.setFieldStyle("color: darkgrey;");b.setValue("0")});this.highlightInstruction(0,BDC.lib.Colors.MAGENTA)},getCell:function(c,b){var a=(c%10)*10+(b%10);var d=Ext.String.format("memory-cell-{0}",a);return this.getComponent(d)},highlightInstruction:function(b,a){var d,c;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a);b=(b+1)%100;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a);b=(b+1)%100;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a)},highlight:function(d,c,b){var a=this.getCell(d,c);var e=Ext.String.format("color: #{0};",b);a.setFieldStyle(e)},resetGray:function(){var a=this.getMemoryCells();Ext.each(a,function(b){b.setFieldStyle("color: darkgrey;")})},getCellValue:function(c,b){var a=this.getCell(c,b);return a.getValue()%10},getNCellValue:function(c){var b,a;b=Math.floor(c/10)%10;a=c%10;return this.getCellValue(b,a)},setCellValue:function(c,b,d){var a=this.getCell(c,b);a.setValue(d%10)},setNCellValue:function(d,c){var b,a;b=Math.floor(d/10)%10;a=d%10;this.setCellValue(b,a,c)}});Ext.define("BDC.lib.FlagsPanel",{extend:"Ext.panel.Panel",alias:"widget.flags-panel",title:"CPU Flags",layout:"vbox",bodyPadding:10,padding:"10 0 0 0",items:[{itemId:"overflow-flag",html:"OF:",baseCls:"register-label",width:75}],setOverflow:function(a){var b=this.getComponent("overflow-flag");if(a===true){b.update("OF: 1")}else{b.update("OF: 0")}}});Ext.define("BDC.lib.HaltPanel",{extend:"Ext.panel.Panel",alias:"widget.halt-panel",border:false,padding:"10 0 0 0",items:[{xtype:"image",cls:"halt-icon",title:"Halted"}],clearHalt:function(){this.setVisible(false)},setHalt:function(){this.setVisible(true)}});Ext.define("BDC.lib.DigitValidator",function(){Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]$/,digit:function(b,a){return this.pattern.test(b)},digitMask:/[0-9]/});Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]*[0-9]$/,"two-digits":function(b,a){return this.pattern.test(b)},"two-digitsMask":/[0-9]/});Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]*[0-9]*[0-9]$/,"three-digits":function(b,a){return this.pattern.test(b)},"three-digitsMask":/[0-9]/});return this}());Ext.define("BDC.lib.RegistersPanel",{extend:"Ext.panel.Panel",alias:"widget.registers-panel",requires:["BDC.lib.DigitValidator"],title:"CPU Registers",layout:"vbox",bodyPadding:10,ac0:0,ac1:0,pc0:0,pc1:0,ir0:0,ir1:0,ir2:0,items:[{xtype:"textfield",itemId:"ACC",fieldLabel:"A:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:20,minLength:1,maxLength:2,selectOnFocus:true,emptyText:"00",vtype:"two-digits",enableKeyEvents:true,listeners:{keypress:function(b){var a=b.getValue();if(a.length===2){b.setRawValue("")}}},width:75},{xtype:"textfield",itemId:"PC",fieldLabel:"PC:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:20,minLength:1,maxLength:2,selectOnFocus:true,emptyText:"00",vtype:"two-digits",enableKeyEvents:true,listeners:{keypress:function(b){var a=b.getValue();if(a.length===2){b.setRawValue("")}}},width:75},{xtype:"textfield",itemId:"IR",fieldLabel:"IR:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:20,minLength:1,maxLength:3,selectOnFocus:true,emptyText:"000",vtype:"three-digits",enableKeyEvents:true,listeners:{keypress:function(b){var a=b.getValue();if(a.length===3){b.setRawValue("")}}},width:75}],clear:function(){var a=this.getComponent("ACC");a.reset();a=this.getComponent("PC");a.reset();a=this.getComponent("IR");a.reset()},setAll:function(){this.setACC();this.setPC();this.setIR()},setACC:function(){var a=this.getComponent("ACC");var b=a.getValue();if(0<=b&&b<100){this.ac1=Math.floor(b/10);this.ac0=b%10}},setACCXY:function(a,c){var b=this.getComponent("ACC");this.ac1=a%10;this.ac0=c%10;b.setValue(""+this.ac1+""+this.ac0)},setACCN:function(c){var a,b;a=Math.floor(c/10)%10;b=c%10;this.setACCXY(a,b)},setPC:function(){var a=this.getComponent("PC");var b=a.getValue();if(0<=b&&b<100){this.pc1=Math.floor(b/10);this.pc0=b%10}},setPCXY:function(a,c){var b=this.getComponent("PC");this.pc1=a%10;this.pc0=c%10;b.setValue(""+this.pc1+""+this.pc0)},setPCN:function(c){var a,b;a=Math.floor(c/10)%10;b=c%10;this.setPCXY(a,b)},setIR:function(){var a=this.getComponent("IR");var b=a.getValue();if(0<=b&&b<1000){this.ir2=Math.floor(b/100);b=b%100;this.ir1=Math.floor(b/10);this.ir0=b%10}},incPC:function(){var a=this.getComponent("PC");this.pc0++;if(this.pc0===10){this.pc0=0;this.pc1=(this.pc1+1)%10}a.setValue(""+this.pc1+""+this.pc0)},setIRXYZ:function(a,d,c){var b=this.getComponent("IR");this.ir2=a%10;this.ir1=d%10;this.ir0=c%10;b.setValue(""+this.ir2+""+this.ir1+""+this.ir0)},setIRN:function(d){var a,c,b;a=Math.floor(d/100)%10;d=d%100;c=Math.floor(d/10);b=d%10;this.setIRXYZ(a,c,b)},setStrings:function(){var a=this.getComponent("ACC");a.setValue(""+this.ac1+""+this.ac0);a=this.getComponent("PC");a.setValue(""+this.pc1+""+this.pc0);a=this.getComponent("IR");a.setValue(""+this.ir2+""+this.ir1+""+this.ir0)}});Ext.define("BDC.lib.StatusPanel",{extend:"Ext.panel.Panel",alias:"widget.status-panel",requires:["BDC.lib.RegistersPanel","BDC.lib.FlagsPanel","BDC.lib.HaltPanel"],columnWidth:0.2,layout:{type:"vbox",align:"center"},padding:"10px",border:false,items:[{xtype:"registers-panel",itemId:"registersPanel"},{xtype:"flags-panel",itemId:"flagsPanel"},{xtype:"halt-panel",itemId:"haltPanel"}]});Ext.define("BDC.view.View",{extend:"Ext.panel.Panel",alias:"widget.bdc-view",requires:["BDC.lib.ButtonsPanel","BDC.lib.MemoryPanel","BDC.lib.StatusPanel"],uses:["BDC.lib.Colors"],width:600,height:350,border:false,of:false,layout:{type:"column"},items:[{xtype:"buttons-panel"},{xtype:"memory-panel",itemId:"memoryPanel"},{xtype:"status-panel",itemId:"statusPanel"}],registersPanel:function(){return Ext.ComponentQuery.query("#registersPanel")[0]},haltPanel:function(){return Ext.ComponentQuery.query("#haltPanel")[0]},flagsPanel:function(){return Ext.ComponentQuery.query("#flagsPanel")[0]},reset:function(){var a=this.getComponent("memoryPanel");a.clear();a=this.registersPanel();a.clear();a=this.haltPanel();a.clearHalt();this.of=false;a=this.flagsPanel();a.setOverflow(this.of)},highlightInstruction:function(c,b){var e,d;var a=this.getComponent("memoryPanel");d=Math.floor(c/10);e=c%10;a.highlight(d,e,b);c=(c+1)%100;d=Math.floor(c/10);e=c%10;a.highlight(d,e,b);c=(c+1)%100;d=Math.floor(c/10);e=c%10;a.highlight(d,e,b)},highlightData:function(e,b){var d,c;var a=this.getComponent("memoryPanel");c=Math.floor(e/10);d=e%10;a.highlight(c,d,b);e=(e+1)%100;c=Math.floor(e/10);d=e%10;a.highlight(c,d,b)},step:function(){var g,p,u,f;var b,e,d,a,n,m,s,r,q;var c,i,j,l,t,k;var h,o;g=this.getComponent("memoryPanel");g.resetGray();p=this.registersPanel();p.setAll();u=this.haltPanel();u.clearHalt();f=this.flagsPanel();e=p.ac0;d=p.ac1;b=e+10*d;n=p.pc0;m=p.pc1;s=g.getCellValue(m,n);p.incPC();n=p.pc0;m=p.pc1;r=g.getCellValue(m,n);p.incPC();n=p.pc0;m=p.pc1;q=g.getCellValue(m,n);p.incPC();n=p.pc0;m=p.pc1;p.setIRXYZ(q,r,s);p.setStrings();a=n+10*m;i=c=s+10*r;j=l=g.getNCellValue(c);t=k=g.getNCellValue((c+1)%100);h=o=l+10*k;if(q>=4){if(c===0){j=e;t=d;h=b}else{if(r===0){i=s+90;j=g.getNCellValue(i);t=g.getNCellValue((i+1)%100);i=j+10*t;j=g.getNCellValue(i);t=g.getNCellValue((i+1)%100);h=j+10*t}}}switch(q){case 0:if(s!==0||r!==0){p.setPCN(a+c)}else{p.setPCN(a+97);u.setHalt()}break;case 1:if(this.of){if(s!==0||r!==0){p.setPCN(a+c)}else{p.setPCN(a+97);u.setHalt()}}break;case 2:if(!this.of){if(s!==0||r!==0){p.setPCN(a+c)}else{p.setPCN(a+97);u.setHalt()}}break;case 3:p.setACCN(c);break;case 4:p.setACCN(h);break;case 5:this.of=b+h>100;p.setACCN((b+h)%100);f.setOverflow(this.of);break;case 6:this.of=b<h;p.setACCN((100+b-h)%100);f.setOverflow(this.of);break;case 7:if(c!==0){g.setNCellValue(i,e);g.setNCellValue((i+1)%100,d)}break;case 8:this.of=h===99;h=(h+1)%100;if(c!==0){t=Math.floor(h/10);j=h%10;g.setNCellValue(i,j);g.setNCellValue((i+1)%100,t)}else{p.setACCN(h)}f.setOverflow(this.of);break;case 9:this.of=h===0;h=(h+99)%100;if(c!==0){t=Math.floor(h/10);j=h%10;g.setNCellValue(i,j);g.setNCellValue((i+1)%100,t)}else{p.setACCN(h)}f.setOverflow(this.of);break}if(q>=4){if(r!==0){this.highlightData(c,BDC.lib.Colors.BLUE)}else{if(s!==0){this.highlightData(90+c,BDC.lib.Colors.GREEN);this.highlightData(i,BDC.lib.Colors.BLUE)}}}n=p.pc0;m=p.pc1;a=n+10*m;this.highlightInstruction(a,BDC.lib.Colors.MAGENTA)},loadProgram:function(d){var k,h,c,b,a=0,g,f,e;k=this.getComponent("memoryPanel");h=this.registersPanel();this.reset();h.setACCN(d[a++]);h.setPCN(d[a++]);h.setIRN(d[a++]);for(c=0;c<10;c++){for(b=0;b<10;b++){k.setCellValue(c,b,d[a++])}}h.setAll();g=h.pc0;f=h.pc1;e=g+10*f;this.highlightInstruction(e,BDC.lib.Colors.MAGENTA)},loadAssembledProgram:function(b){var a,d,c,e=0;a=this.getComponent("memoryPanel");this.reset();for(d=0;d<10;d++){for(c=0;c<10;c++){a.setCellValue(d,c,b[e++])}}this.highlightInstruction(0,BDC.lib.Colors.MAGENTA)}});Ext.define("BDC.controller.Controller",{extend:"Ext.app.Controller",uses:["BDC.lib.Programs","BDC.lib.AssemblerEditor"],views:["BDC.view.View"],refs:[{selector:"bdc-view",ref:"BDCView"},{selector:"panel[itemId=bdc-assembler]",ref:"Assembler"}],init:function(){this.control({"bdc-view":{afterrender:this.onViewAfterRender},"#assemblerButton":{click:this.onAssembler},"#assembleButton":{click:this.onAssemble},"#resetButton":{click:this.onReset},"#stepButton":{click:this.onStep},"#programOne":{click:this.onProgramOne},"#programTwo":{click:this.onProgramTwo},"#programThree":{click:this.onProgramThree},"#programFour":{click:this.onProgramFour},"#programFive":{click:this.onProgramFive},"#programSix":{click:this.onProgramSix}})},onViewAfterRender:function(a){a.reset()},onAssembler:function(){BDC.lib.AssemblerEditor.show()},onAssemble:function(){var f,c,b=this.getAssembler();var a=this.getBDCView();try{f=b.assemble()}catch(d){c=Ext.String.format("Error: {0}, Line: {1}",d.error,d.line_no);Ext.Msg.alert(c);return}a.loadAssembledProgram(f)},onReset:function(){var a=this.getBDCView();a.reset()},onStep:function(){var a=this.getBDCView();a.step()},onProgramOne:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_ONE)},onProgramTwo:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_TWO)},onProgramThree:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_THREE)},onProgramFour:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_FOUR)},onProgramFive:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_FIVE)},onProgramSix:function(){var a=this.getBDCView();a.loadProgram(BDC.lib.Programs.PROGRAM_SIX)}});Ext.define("BDC.lib.Colors",{statics:{BLUE:"0000FF",GREEN:"00FF00",MAGENTA:"FF00FF"}});Ext.define("BDC.lib.Programs",{statics:{PROGRAM_ONE:[0,0,0,0,0,3,8,9,7,4,9,9,9,0,1,8,9,4,6,9,5,2,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,5,0,0,0],PROGRAM_TWO:[0,0,0,0,0,3,8,9,7,4,9,4,6,9,6,6,0,1,8,9,8,8,8,0,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,2,3,0,0,0],PROGRAM_THREE:[0,0,0,0,0,3,8,9,7,8,9,4,4,9,5,8,9,7,4,9,8,6,9,4,4,9,6,9,7,2,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,2,1,0,0],PROGRAM_FOUR:[0,0,0,1,0,3,4,9,7,6,9,7,4,9,4,6,9,5,8,9,7,6,9,4,4,9,7,8,9,4,6,9,7,6,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,3,0,0,0],PROGRAM_FIVE:[0,0,0,9,9,3,8,9,7,1,0,3,6,9,7,4,9,4,6,9,6,5,1,1,8,9,8,6,9,4,6,9,5,6,9,7,6,7,0,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,0,0,0,0],PROGRAM_SIX:[0,0,0,0,0,3,8,9,9,5,1,1,6,0,5,6,9,8,6,9,8,8,9,9,5,8,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,1,1,5,0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0]}});Ext.define("BDC.lib.Assembler",{uses:["BDC.lib.Character"],statics:{PROGRAM_SIZE:100,MNEMONICS:{halt:-1,j:0,jo:1,jno:2,loadi:3,load:4,add:5,sub:6,store:7,inc:8,dec:9},TT_EMPTY:0,TT_ID:1,TT_NUMBER:2,TT_LABEL:3,TT_LBRACKET:4,TT_RBRACKET:5,PSEUDO_REGS:{q:80,r:82,s:84,t:86,u:88,v:90,w:92,x:94,y:96,z:98}},memory:[],symbols:{},refs:[],program:"",token:"",tt:undefined,i_index:0,o_index:0,line_no:0,initialize:function(){this.memory=Array.apply(null,new Array(this.self.PROGRAM_SIZE)).map(Number.prototype.valueOf,0);this.symbols={};this.refs=[];this.i_index=this.o_index=0;this.line_no=1;this.token=this.program="";this.tt=this.self.TT_EMPTY},constructor:function(){this.initialize()},assemble:function(a){this.initialize();this.program=a.toLowerCase();this.parse();this.resolve();return this.memory},parse:function(){this.i_index=0;while(true){this.getToken();switch(this.tt){case this.self.TT_EMPTY:return;case this.self.TT_LABEL:this.label();break;case this.self.TT_ID:this.instruction();break;default:this.syntax_error();break}}},resolve:function(){Ext.each(this.refs,function(b){var c,a;if((c=this.symbols[b.name])===undefined){a=Ext.String.format("can't find label {0}.",b.name);throw {error:a,line_no:b.line_no}}c=c-b.location-3;c=((c%this.self.PROGRAM_SIZE)+this.self.PROGRAM_SIZE)%this.self.PROGRAM_SIZE;this.memory[b.location]=c%10;this.memory[b.location+1]=Math.floor(c/10)},this)},getToken:function(){var b,a=this.program.length;this.tt=this.self.TT_EMPTY;for(this.token="";this.i_index<a;++this.i_index){b=this.program[this.i_index];switch(b){case" ":case"\t":case"\r":if(this.token.length){return}break;case":":if(this.token.length){this.i_index++;this.tt=this.self.TT_LABEL;return}else{this.syntax_error()}break;case";":this.comment();break;case"[":if(this.token.length){return}this.token=b;this.i_index++;this.tt=this.self.TT_LBRACKET;return;case"]":if(this.token.length){return}this.token=b;this.i_index++;this.tt=this.self.TT_RBRACKET;return;case"\n":this.line_no++;if(this.token.length){return}break;default:if(BDC.lib.Character.isdigit(b)){if(this.tt===this.self.TT_EMPTY){this.tt=this.self.TT_NUMBER}this.token+=b;continue}else{if(BDC.lib.Character.isalpha(b)){this.tt=this.self.TT_ID;this.token+=b;continue}else{this.syntax_error()}}break}}},instruction:function(){var a;if(this.token.length===0){this.syntax_error()}if((a=this.self.MNEMONICS[this.token])===undefined){this.syntax_error()}this.assemble_instr(a)},assemble_instr:function(a){switch(a){case this.self.MNEMONICS.halt:this.halt();break;case this.self.MNEMONICS.j:this.jump();break;case this.self.MNEMONICS.jo:this.jo();break;case this.self.MNEMONICS.jno:this.jno();break;case this.self.MNEMONICS.loadi:this.loadi();break;case this.self.MNEMONICS.load:this.load();break;case this.self.MNEMONICS.add:this.add();break;case this.self.MNEMONICS.sub:this.sub();break;case this.self.MNEMONICS.store:this.store();break;case this.self.MNEMONICS.inc:this.inc();break;case this.self.MNEMONICS.dec:this.dec();break}},assemble_val:function(a){this.memory[this.o_index++]=a%10;this.memory[this.o_index++]=Math.floor(a/10)},halt:function(){this.assemble_val(0);this.memory[this.o_index++]=this.self.MNEMONICS.j},jump:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.j},jo:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.jo},jno:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.jno},load:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.load},loadi:function(){var a=this.getImmediate();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.loadi},store:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.store},add:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.add},sub:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.sub},inc:function(){var a=this.getMemAcc();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.inc},dec:function(){var a=this.getMemAcc();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.dec},getImmediate:function(){this.getToken();if(this.tt!==this.self.TT_NUMBER){this.syntax_error()}return this.parseValue()},parseValue:function(){var a=parseInt(this.token,10);if(isNaN(a)){this.syntax_error()}if(0>a||a>99){this.error("number out of range.")}return a},getMemory:function(){this.getToken();return this.getMemValue()},getMemValue:function(){var a;if(this.tt===this.self.TT_LBRACKET){if((a=this.getIndirect())===false){this.syntax_error()}return a}if(this.tt!==this.self.TT_NUMBER&&this.tt!==this.self.TT_ID){this.syntax_error()}if(this.tt===this.self.TT_NUMBER){return this.parseValue()}if((a=this.self.PSEUDO_REGS[this.token])===undefined){this.error("undefined symbol")}return a},getMemAcc:function(){this.getToken();if(this.tt===this.self.TT_ID&&this.token==="a"){return 0}return this.getMemValue()},getIndirect:function(){var b,a;this.getToken();if(this.tt!==this.self.TT_ID){return false}a=this.token;this.getToken();if(this.tt!==this.self.TT_RBRACKET){return false}if(a.match(/^[w-z]$/)===null){return false}if((b=this.self.PSEUDO_REGS[a])===undefined){return false}b=b-this.self.PSEUDO_REGS.v;return b},getTarget:function(){var a;this.getToken();if(this.tt!==this.self.TT_NUMBER&&this.tt!==this.self.TT_ID){this.syntax_error()}if(this.tt===this.self.TT_NUMBER){return this.parseValue()}if((a=this.symbols[this.token])!==undefined){a=((this.self.PROGRAM_SIZE-this.o_index)+a)-3;a=((a%this.self.PROGRAM_SIZE)+this.self.PROGRAM_SIZE)%this.self.PROGRAM_SIZE;return a}this.refs.push({name:this.token,location:this.o_index,line_no:this.line_no});return 0},comment:function(){var b,a=this.program.length;for(;this.i_index<a;++this.i_index){b=this.program[this.i_index];if(b==="\n"){this.i_index--;return}}},label:function(){if(this.token.length===0){this.syntax_error()}if(this.symbols[this.token]!==undefined){this.error("label already defined.")}if(this.self.PSEUDO_REGS[this.token]!==undefined){this.error("illegal label.")}this.symbols[this.token]=this.o_index},syntax_error:function(){this.error("syntax error.")},error:function(a){throw {error:a,line_no:this.line_no}}});Ext.define("BDC.lib.AssemblerEditor",{extend:"Ext.panel.Panel",requires:"BDC.lib.Assembler",itemId:"bdc-assembler",title:"BDC Assembler",renderTo:"bdc-assembler",iconCls:"assemble-icon",closable:true,width:600,height:375,collapsible:true,statics:{show:function(){if(Ext.ComponentQuery.query("panel[itemId=bdc-assembler]")[0]){return}return Ext.create("BDC.lib.AssemblerEditor")}},dockedItems:[{xtype:"toolbar",items:[{xtype:"button",tooltip:{text:"Assemble Source Code",title:"Assemble"},text:"Assemble Source Code",iconCls:"assemble-icon",focusCls:"",id:"assembleButton"}]}],items:[{xtype:"textarea",itemId:"assembler-text",width:600,height:375,fieldStyle:{fontFamily:"courier new",fontSize:"14px"},validationEvent:false,enableKeyEvents:true,listeners:{keydown:function(b,a){if(a.getKey()===a.TAB){a.stopEvent();b.insertTab()}}},insertTab:function(){var b=this.inputEl.dom;if(b.setSelectionRange){var a=b.value.substring(0,b.selectionStart)+"\t";var c=a.length;b.value=a+b.value.substring(b.selectionEnd,b.value.length);b.setSelectionRange(c,c)}else{if(document.selection){document.selection.createRange().text="\t"}}}}],assembler:Ext.create("BDC.lib.Assembler"),assemble:function(){var b=this.getComponent("assembler-text");var a=b.getValue();return this.assembler.assemble(a)}});Ext.define("BDC.lib.Frame",{extend:"Ext.panel.Panel",alias:"bdc-frame",itemId:"bdc-frame",title:"Basic Decimal Computer",renderTo:"bdc-app",iconCls:"cpu-icon",width:600,height:375,layout:"fit",items:[{xtype:"bdc-view"}],initComponent:function(){Ext.QuickTips.init();this.callParent(arguments)}});Ext.define("BDC.lib.Character",{statics:{isalpha:function(a){return(((a>="a")&&(a<="z"))||((a>="A")&&(a<="Z")))},isdigit:function(a){return((a>="0")&&(a<="9"))},isalnum:function(a){return(this.isalpha(a)||this.isdigit(a))}}});Ext.application({name:"BDC",appFolder:"app",controllers:["Controller"],uses:"BDC.lib.Frame",launch:function(){Ext.create("bdc-frame").show()}});$(function(){$("#tabs").tabs({activate:function(a,b){var c;if(b.newTab.index()===1){c=Ext.ComponentQuery.query("#bdc-frame")[0];if(c){c.doLayout()}}}})});
