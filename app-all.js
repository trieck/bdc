/*
Copyright(c) 2014 Michael Q. Rieck, Thomas A. Rieck
*/
Ext.define("BDC.store.Disassembly",{extend:"Ext.data.Store",autoLoad:true,autoSync:true,statics:{ADDRESS_TABLE:{2:"[W]",4:"[X]",6:"[Y]",8:"[Z]",80:"Q",82:"R",84:"S",86:"T",88:"U",90:"V",92:"W",94:"X",96:"Y",98:"Z"}},fields:[{name:"location",type:"int"},{name:"instruction",type:"string"},{name:"ir",type:"auto"}],data:Array.apply(null,new Array(26)).map(function(b,a){return{location:a*3,instruction:"HALT",ir:[0,0,0]}}),onUpdateMemory:function(b,a,c){if(c===Ext.data.Model.COMMIT){if(a.index>25*3){return}this.updateMemory(a)}},updateMemory:function(d){var b=Math.floor(d.index/3);var a=this.getAt(b);var e=d.index%3;var c=a.get("ir");c[e]=d.data.value;a.set("ir",c);this.format(a)},format:function(b){var a;var c=b.get("ir");switch(c[2]){case 0:if(c[0]===0&&c[1]===0){a="HALT"}else{a=Ext.String.format("J {0}",this.formatTarget(b))}break;case 1:a=Ext.String.format("JO {0}",this.formatTarget(b));break;case 2:a=Ext.String.format("JNO {0}",this.formatTarget(b));break;case 3:a=Ext.String.format("LOADI {0}{1}",c[1],c[0]);break;case 4:a=Ext.String.format("LOAD {0}",this.formatAddress(b));break;case 5:a=Ext.String.format("ADD {0}",this.formatAddress(b));break;case 6:a=Ext.String.format("SUB {0}",this.formatAddress(b));break;case 7:if(c[0]===0&&c[1]===0){a="OUTPUT"}else{a=Ext.String.format("STORE {0}",this.formatAddress(b))}break;case 8:if(c[0]===0&&c[1]===0){a=Ext.String.format("INC A")}else{a=Ext.String.format("INC {0}",this.formatAddress(b))}break;case 9:if(c[0]===0&&c[1]===0){a=Ext.String.format("DEC A")}else{a=Ext.String.format("DEC {0}",this.formatAddress(b))}break}b.set("instruction",a)},formatTarget:function(c){var g,b,a,f,e,d;g=c.get("ir");a=c.get("location");b=g[1]*10+g[0];f=(a+3)-(100-b);f=((f%100)+100)%100;d=Math.floor(f/10);e=f%10;return Ext.String.format("{0}{1}",d,e)},formatAddress:function(b){var d=b.get("ir");var a=d[1]*10+d[0];var c;if((c=this.self.ADDRESS_TABLE[a])!==undefined){return c}return Ext.String.format("{0}{1}",d[1],d[0])}});Ext.define("BDC.store.MachineList",{extend:"Ext.data.Store",autoLoad:false,remoteSort:true,fields:[{name:"name",type:"string"},{name:"date",type:"date"}],proxy:{type:"ajax",url:"./cgi-bin/list.rb",reader:{type:"json",root:"machines"}}});Ext.define("BDC.lib.ButtonsPanel",{extend:"Ext.panel.Panel",alias:"widget.buttons-panel",layout:{type:"vbox",align:"center"},width:140,height:350,title:"Options",padding:"10 10 10 15",items:[{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Step the machine"},text:"STEP",focusCls:"",id:"stepButton",iconCls:"step-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Load Program/Machine"},text:"LOAD",focusCls:"",id:"loadButton",iconCls:"load-icon",iconAlign:"top",width:"80%",flex:0.6,menu:{items:[{text:"Canned Programs",iconCls:"can-icon",menu:{plain:true,items:[{text:"Multiply X and Y",id:"programOne",iconCls:"tape-icon"},{text:"Divide X by Y",id:"programTwo",iconCls:"tape-icon"},{text:"Add numbers from X up to Y",id:"programThree",iconCls:"tape-icon"},{text:"Generate Fibonacci numbers",id:"programFour",iconCls:"tape-icon"},{text:"Compute base-2 Logarithm of X",id:"programFive",iconCls:"tape-icon"},{text:"Add data in array",id:"programSix",iconCls:"tape-icon"}]}},{text:"Program from Text...",iconCls:"text-icon",id:"loadTextButton"},{text:"From Database...",iconCls:"database-icon",id:"loadMachineButton"}]}},{border:false,flex:0.1},{xtype:"button",tooltip:{text:"Save Program/Machine"},text:"SAVE",focusCls:"",id:"saveButton",iconCls:"save-icon",iconAlign:"top",width:"80%",flex:0.6,menu:[{text:"Program to Text...",iconCls:"text-icon",id:"saveTextButton"},{text:"To Database...",iconCls:"database-icon",id:"saveMachineButton"}]},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Reset the machine"},text:"RESET",focusCls:"",id:"resetButton",iconCls:"reset-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2},{xtype:"button",tooltip:{text:"Launch Assembler Editor"},text:"ASSEMBLER",focusCls:"",id:"assemblerButton",iconCls:"assemble-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.1},{xtype:"button",tooltip:{text:"Launch Disassembler"},text:"DISASSEMBLER",focusCls:"",id:"disassemblerButton",iconCls:"disassemble-icon",iconAlign:"top",width:"80%",flex:0.6},{border:false,flex:0.2}]});Ext.define("BDC.lib.MemoryPanel",{extend:"Ext.panel.Panel",alias:"widget.memory-panel",title:"Main Memory",uses:["BDC.lib.Colors","BDC.lib.DigitValidator"],width:350,height:350,layout:{type:"table",columns:11},padding:"10 0 10 5",keyPress:function(d,c){var b=c.getCharCode(),a;if(b<48||b>57){c.stopEvent();return}a=Ext.getStore("Memory");a.setCellValue(this.cellIndex,b-48);d.setRawValue("")},initComponent:function(){var b,a;this.callParent(arguments);for(b=0;b<11;++b){if(b===0){this.add({border:false})}else{this.add({baseCls:"memory-col-header",html:""+(b-1),padding:"10 5 7 11"})}}for(b=0,a=0;b<100;++b){if(b%10===0){this.add({baseCls:"memory-row-header",html:""+a++,padding:"0 15 0 10"})}this.add({xtype:"textfield",minLength:1,maxLength:1,fieldCls:"memory-cell",selectOnFocus:true,emptyText:"0",width:25,itemId:"memory-cell-"+b,cellIndex:b,vtype:"digit",enableKeyEvents:true,listeners:{keypress:this.keyPress},margin:"2px"})}},getMemoryCells:function(){return this.query("textfield[itemId^=memory-cell]")},clear:function(){var a=this.getMemoryCells();Ext.each(a,function(b){b.reset();b.setFieldStyle("color: dimgrey;");b.setValue("0")});this.highlightInstruction(0,BDC.lib.Colors.MAGENTA)},getCell:function(c,b){var a=(c%10)*10+(b%10);var d=Ext.String.format("memory-cell-{0}",a);return this.getComponent(d)},highlightInstruction:function(b,a){var d,c;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a);b=(b+1)%100;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a);b=(b+1)%100;c=Math.floor(b/10);d=b%10;this.highlight(c,d,a)},highlight:function(d,c,b){var a=this.getCell(d,c);var e=Ext.String.format("color: #{0};",b);a.setFieldStyle(e)},resetGray:function(){var a=this.getMemoryCells();Ext.each(a,function(b){b.setFieldStyle("color: dimgrey;")})},getCellValue:function(c,b){var a=this.getCell(c,b);return a.getValue()%10},setCellValue:function(c,b,d){var a=this.getCell(c,b);a.setValue(d%10)},setNCellValue:function(d,c){var b,a;b=Math.floor(d/10)%10;a=d%10;this.setCellValue(b,a,c)}});Ext.define("BDC.model.Machine",{extend:"Ext.data.Model",fields:[{name:"halted",type:"boolean"},{name:"overflow_flag",type:"boolean"},{name:"reg_a",type:"int"},{name:"reg_pc",type:"int"},{name:"reg_ir",type:"int"}]});Ext.define("BDC.model.MemoryCell",{extend:"Ext.data.Model",fields:[{name:"value",type:"int"}]});Ext.define("BDC.lib.FlagsPanel",{extend:"Ext.panel.Panel",alias:"widget.flags-panel",title:"CPU Flags",layout:"vbox",bodyPadding:10,padding:"10 0 0 0",width:100,items:[{itemId:"overflow-flag",html:"OF:",baseCls:"register-label",width:75}],setOverflow:function(a){var b=this.getComponent("overflow-flag");if(a===true){b.update("OF: 1")}else{b.update("OF: 0")}}});Ext.define("BDC.lib.HaltPanel",{extend:"Ext.panel.Panel",alias:"widget.halt-panel",border:false,padding:"10 0 0 0",items:[{xtype:"image",cls:"halt-icon",title:"Halted"}],clearHalt:function(){this.setVisible(false)},setHalt:function(){this.setVisible(true)}});Ext.define("BDC.lib.DigitValidator",function(){Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]$/,digit:function(b,a){return this.pattern.test(b)},digitMask:/[0-9]/});Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]*[0-9]$/,"two-digits":function(b,a){return this.pattern.test(b)},"two-digitsMask":/[0-9]/});Ext.apply(Ext.form.field.VTypes,{pattern:/^[0-9]*[0-9]*[0-9]$/,"three-digits":function(b,a){return this.pattern.test(b)},"three-digitsMask":/[0-9]/});return this}());Ext.define("BDC.lib.OutputDigit",{extend:"Ext.container.Container",alias:"widget.output-digit",statics:{CHAR_SET:["1111110","0110000","1101101","1111001","0110011","1011011","0011111","1110000","1111111","1111011","1110111","1001110","1001111","1000111","1011110","0110111","1111000","0001110","1110110","1100111","0111110","0000000"]},width:10,height:14,padding:1,componentCls:"output-digit",items:[{xtype:"component",componentCls:"digit-section digit-middle",itemId:"section-0"},{xtype:"component",componentCls:"digit-section digit-top-left",itemId:"section-1"},{xtype:"component",componentCls:"digit-section digit-bottom-left",itemId:"section-2"},{xtype:"component",componentCls:"digit-section digit-bottom",itemId:"section-3"},{xtype:"component",componentCls:"digit-section digit-bottom-right",itemId:"section-4"},{xtype:"component",componentCls:"digit-section digit-top-right",itemId:"section-5"},{xtype:"component",componentCls:"digit-section digit-top",itemId:"section-6"}],clear:function(){var a=this.query("component[itemId^=section-]");Ext.each(a,function(b){b.setVisible(false)})},set:function(c){var a,e,b,d;c=c%this.self.CHAR_SET.length;b=this.self.CHAR_SET[c];e=parseInt(b,2);for(a=0;a<7;++a){d=this.getComponent("section-"+a);if(e&(1<<a)){d.setVisible(true)}else{d.setVisible(false)}}}});Ext.define("BDC.store.Machine",{extend:"Ext.data.Store",model:"BDC.model.Machine",autoLoad:true,autoSync:true,data:{halted:false,overflow_flag:false,reg_a:0,reg_pc:0,reg_ir:0},proxy:{type:"memory"},getRecord:function(){return this.getAt(0)},getHalted:function(){return this.getRecord().get("halted")},setHalted:function(a){this.getRecord().set("halted",!!a)},getOverflow:function(){return this.getRecord().get("overflow_flag")},setOverflow:function(a){this.getRecord().set("overflow_flag",!!a)},getACC:function(){return this.getRecord().get("reg_a")},setACC:function(a){this.getRecord().set("reg_a",a%100)},setACCRaw:function(a){this.suspendEvent("update");this.setACC(a);this.resumeEvent("update")},setPC:function(a){this.getRecord().set("reg_pc",a%100)},setPCRaw:function(a){this.suspendEvent("update");this.setPC(a);this.resumeEvent("update")},getPC:function(){return this.getRecord().get("reg_pc")},setIR:function(a){this.getRecord().set("reg_ir",a%1000)},setIRRaw:function(a){this.suspendEvent("update");this.setIR(a);this.resumeEvent("update")},getIR:function(){return this.getRecord().get("reg_ir")},reset:function(){this.startBatch();this.setHalted(false);this.setOverflow(false);this.setACC(0);this.setPC(0);this.setIR(0);this.endBatch()},startBatch:function(){this.suspendEvent("update")},endBatch:function(){this.resumeEvent("update");this.fireEventArgs("update",[this,this.getRecord(),Ext.data.Model.COMMIT])},output:function(){var b=Ext.getStore("Memory");var a=b.getCellValue(80);this.fireEvent("output",a,this.getACC())},step:function(){var g=this.getPC();var d=this.getOverflow();var f=Ext.getStore("Memory");var h;var b=f.getCellValue(g);var a=f.getCellValue(++g);var j=f.getCellValue(++g);var i=b+10*a;var c=i;var e=this.getACC();g=(g+1)%100;this.startBatch();this.setPC(g);this.setIR(j*100+a*10+b);if(j>=4&&b===0&&a===0){h=e}else{if(j>=4&&a===0){c=f.getWord(b+90);h=f.getWord(c)}else{if(j>=4&&j!==7){h=f.getWord(i)}}}switch(j){case 0:if(b!==0||a!==0){this.setPC(g+i)}else{this.setPC(g+97);this.setHalted(true)}break;case 1:if(d){if(b!==0||a!==0){this.setPC(g+i)}else{this.setPC(g+97);this.setHalted(true)}}break;case 2:if(!d){if(b!==0||a!==0){this.setPC(g+i)}else{this.setPC(g+97);this.setHalted(true)}}break;case 3:this.setACC(i);break;case 4:this.setACC(h);break;case 5:d=e+h>99;this.setACC(e+h);this.setOverflow(d);break;case 6:d=e<h;this.setACC(100+e-h);this.setOverflow(d);break;case 7:if(i!==0){f.setWord(c,e)}else{this.output()}break;case 8:d=h===99;h=(h+1)%100;if(i===0){this.setACC(h)}else{f.setWord(c,h)}this.setOverflow(d);break;case 9:d=h===0;h=(h+99)%100;if(i===0){this.setACC(h)}else{f.setWord(c,h)}this.setOverflow(d);break}this.endBatch();if(j>=4){if(a!==0){this.fireEvent("dataAccess",i)}else{if(b!==0){this.fireEvent("indirectAccess",90+i);this.fireEvent("dataAccess",c)}}}},loadProgram:function(a){var b,d=0;var c=Ext.getStore("Memory");this.startBatch();this.setACC(a[d++]);this.setPC(a[d++]);this.setIR(a[d++]);this.endBatch();for(b=0;b<100;++b){c.setCellValue(b,a[d++])}}});Ext.define("BDC.store.Memory",{extend:"Ext.data.ArrayStore",model:"BDC.model.MemoryCell",autoLoad:true,autoSync:true,expandData:true,data:Array.apply(null,new Array(100)).map(Number.prototype.valueOf,0),getCellValue:function(b){var a=this.getAt(b%100);return a.get("value")},getWord:function(a){var c=this.getCellValue(a);var b=this.getCellValue(a+1);return c+10*b},setWord:function(b,c){var d=Math.floor(c/10);var a=c%10;this.setCellValue(b,a);this.setCellValue(b+1,d)},setCellValue:function(b,c){var a=this.getAt(b%100);a.set("value",c%10)},clear:function(){this.each(function(a){a.set("value",0)})},loadProgram:function(a){var b;for(b=0;b<100;++b){this.setCellValue(b,a[b])}}});Ext.define("BDC.lib.RegistersPanel",{extend:"Ext.panel.Panel",alias:"widget.registers-panel",requires:["BDC.lib.DigitValidator"],title:"CPU Registers",layout:"vbox",bodyPadding:10,width:100,items:[{xtype:"textfield",itemId:"ACC",fieldLabel:"A:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:30,minLength:1,maxLength:2,selectOnFocus:true,emptyText:"00",vtype:"two-digits",enableKeyEvents:true,listeners:{keyup:function(d,c){var b=c.getCharCode(),a;if(b<48||b>57){c.stopEvent();return}a=Ext.getStore("Machine");a.setACCRaw(d.getValue())},keypress:function(d,b){var a=b.getCharCode();if(a<48||a>57){b.stopEvent();return}var c=d.getValue();if(c.length===2){d.setRawValue("")}}},width:65},{xtype:"textfield",itemId:"PC",fieldLabel:"PC:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:30,minLength:1,maxLength:2,selectOnFocus:true,emptyText:"00",vtype:"two-digits",enableKeyEvents:true,listeners:{keyup:function(d,c){var b=c.getCharCode(),a;if(b<48||b>57){c.stopEvent();return}a=Ext.getStore("Machine");a.setPCRaw(d.getValue())},keypress:function(d,b){var a=b.getCharCode();if(a<48||a>57){b.stopEvent();return}var c=d.getValue();if(c.length===2){d.setRawValue("")}}},width:65},{xtype:"textfield",itemId:"IR",fieldLabel:"IR:",fieldCls:"memory-cell",labelCls:"register-label",labelWidth:30,minLength:1,maxLength:3,selectOnFocus:true,emptyText:"000",vtype:"three-digits",enableKeyEvents:true,listeners:{keyup:function(d,c){var b=c.getCharCode(),a;if(b<48||b>57){c.stopEvent();return}a=Ext.getStore("Machine");a.setIRRaw(d.getValue())},keypress:function(d,b){var a=b.getCharCode();if(a<48||a>57){b.stopEvent();return}var c=d.getValue();if(c.length===3){d.setRawValue("")}}},width:65}],clear:function(){var a=this.getComponent("ACC");a.reset();a.setValue("00");a=this.getComponent("PC");a.reset();a.setValue("00");a=this.getComponent("IR");a.reset();a.setValue("000")},setACC:function(d){var a,c,b=this.getComponent("ACC");a=Math.floor(d/10)%10;c=d%10;b.setValue(a+""+c)},setPC:function(d){var a,c,b=this.getComponent("PC");a=Math.floor(d/10)%10;c=d%10;b.setValue(a+""+c)},setIR:function(e){var a,d,c,b=this.getComponent("IR");a=Math.floor(e/100)%10;e=e%100;d=Math.floor(e/10);c=e%10;b.setValue(a+""+d+""+c)}});Ext.define("BDC.lib.OutputPanel",{extend:"Ext.panel.Panel",alias:"widget.output-panel",requires:"BDC.lib.OutputDigit",title:"Output",bodyPadding:"5 0 0 5",padding:"10 0 0 0",width:100,height:60,border:true,bodyCls:"output-panel",layout:"hbox",items:[{xtype:"output-digit",itemId:"digit-0"},{xtype:"output-digit",itemId:"digit-1"},{xtype:"output-digit",itemId:"digit-2"},{xtype:"output-digit",itemId:"digit-3"},{xtype:"output-digit",itemId:"digit-4"},{xtype:"output-digit",itemId:"digit-5"},{xtype:"output-digit",itemId:"digit-6"},{xtype:"output-digit",itemId:"digit-7"},{xtype:"output-digit",itemId:"digit-8"}],clear:function(){var a=this.query("output-digit[itemId^=digit-]");Ext.each(a,function(b){b.clear()})},set:function(a,b){var c;a=a%9;c=this.getComponent("digit-"+a);if(c){c.set(b)}}});Ext.define("BDC.lib.StatusPanel",{extend:"Ext.panel.Panel",alias:"widget.status-panel",requires:["BDC.lib.RegistersPanel","BDC.lib.FlagsPanel","BDC.lib.HaltPanel","BDC.lib.OutputPanel"],width:130,layout:{type:"vbox",align:"center"},padding:"10 0 0 0",border:false,items:[{xtype:"registers-panel",itemId:"registersPanel"},{xtype:"flags-panel",itemId:"flagsPanel"},{xtype:"output-panel",itemId:"outputPanel"},{xtype:"halt-panel",itemId:"haltPanel"}]});Ext.define("BDC.view.View",{extend:"Ext.panel.Panel",alias:"widget.bdc-view",requires:["BDC.lib.ButtonsPanel","BDC.lib.MemoryPanel","BDC.lib.StatusPanel"],uses:["BDC.lib.Colors"],height:350,border:false,layout:{type:"column"},items:[{xtype:"buttons-panel"},{xtype:"memory-panel",itemId:"memoryPanel"},{xtype:"status-panel",itemId:"statusPanel"}],registersPanel:function(){return Ext.ComponentQuery.query("#registersPanel")[0]},haltPanel:function(){return Ext.ComponentQuery.query("#haltPanel")[0]},flagsPanel:function(){return Ext.ComponentQuery.query("#flagsPanel")[0]},outputPanel:function(){return Ext.ComponentQuery.query("#outputPanel")[0]},reset:function(){var a=this.getComponent("memoryPanel");a.clear();a=this.registersPanel();a.clear();a=this.flagsPanel();a.setOverflow(false);a=this.haltPanel();a.clearHalt();a=this.outputPanel();a.clear()},setStep:function(){var a=this.getComponent("memoryPanel");a.resetGray();a=this.haltPanel();a.clearHalt()},highlightInstruction:function(c,b){var e,d;var a=this.getComponent("memoryPanel");d=Math.floor(c/10);e=c%10;a.highlight(d,e,b);c=(c+1)%100;d=Math.floor(c/10);e=c%10;a.highlight(d,e,b);c=(c+1)%100;d=Math.floor(c/10);e=c%10;a.highlight(d,e,b)},highlightData:function(e,b){var d,c;var a=this.getComponent("memoryPanel");c=Math.floor(e/10);d=e%10;a.highlight(c,d,b);e=(e+1)%100;c=Math.floor(e/10);d=e%10;a.highlight(c,d,b)},updateMemory:function(b){var a=this.getComponent("memoryPanel");a.setNCellValue(b.index,b.data.value)},updateMachine:function(b){var a=this.registersPanel();a.setACC(b.data.reg_a);a.setPC(b.data.reg_pc);a.setIR(b.data.reg_ir);a=this.flagsPanel();a.setOverflow(b.data.overflow_flag);a=this.haltPanel();if(b.data.halted){a.setHalt()}else{a.clearHalt()}this.highlightInstruction(b.data.reg_pc,BDC.lib.Colors.MAGENTA)},dataAccess:function(a){this.highlightData(a,BDC.lib.Colors.BLUE)},indirectAccess:function(a){this.highlightData(a,BDC.lib.Colors.GREEN)},output:function(a,c){var b=this.outputPanel();b.set(a,c)}});Ext.define("BDC.controller.Controller",{extend:"Ext.app.Controller",uses:["BDC.lib.Programs","BDC.lib.AssemblerEditor","BDC.lib.Disassembler","BDC.lib.MachineLoadDialog"],stores:["Machine","Memory","Disassembly","MachineList"],views:["BDC.view.View"],refs:[{selector:"bdc-view",ref:"BDCView"},{selector:"panel[itemId=bdc-assembler]",ref:"Assembler"}],init:function(){this.control({"bdc-view":{afterrender:this.onReset},"#assemblerButton":{click:this.onAssembler},"#disassemblerButton":{click:this.onDisassembler},"#assembleButton":{click:this.onAssemble},"#resetButton":{click:this.onReset},"#stepButton":{click:this.onStep},"#loadTextButton":{click:this.onLoadText},"#loadMachineButton":{click:this.onLoadMachine},"#saveTextButton":{click:this.onSaveText},"#saveMachineButton":{click:this.onSaveMachine},"#programOne":{click:this.onProgramOne},"#programTwo":{click:this.onProgramTwo},"#programThree":{click:this.onProgramThree},"#programFour":{click:this.onProgramFour},"#programFive":{click:this.onProgramFive},"#programSix":{click:this.onProgramSix},"#loadDialog":{loadMachine:this.loadMachine},"#machinesPanel":{deleteMachine:this.deleteMachine}})},onLaunch:function(){var c=this.getMemoryStore();var b=this.getMachineStore();var a=this.getDisassemblyStore();c.on("update",a.onUpdateMemory,a);c.on("update",this.onUpdateMemory,this);b.on("update",this.onUpdateMachine,this);b.on("dataAccess",this.onDataAccess,this);b.on("indirectAccess",this.onIndirectAccess,this);b.on("output",this.onOutput,this)},onUpdateMemory:function(b,a,c){if(c===Ext.data.Model.COMMIT){this.getBDCView().updateMemory(a)}},onUpdateMachine:function(b,a,c){if(c===Ext.data.Model.COMMIT){this.getBDCView().updateMachine(a)}},onDataAccess:function(a){this.getBDCView().dataAccess(a)},onIndirectAccess:function(a){this.getBDCView().indirectAccess(a)},onOutput:function(a,b){this.getBDCView().output(a,b)},onAssembler:function(){BDC.lib.AssemblerEditor.show()},onDisassembler:function(){BDC.lib.Disassembler.show()},onAssemble:function(){var f,c,b=this.getAssembler();var a=this.getMemoryStore();try{f=b.assemble()}catch(d){c=Ext.String.format("Error: {0}, Line: {1}",d.error,d.line_no);Ext.Msg.alert("Error",c);return}this.onReset();a.loadProgram(f)},onReset:function(){var a=this.getBDCView();var c=this.getMemoryStore();var b=this.getMachineStore();c.clear();b.reset();a.reset()},onStep:function(){var a=this.getBDCView();var b=this.getMachineStore();a.setStep();b.step()},onLoadText:function(){var c,d;var b=Array.apply(null,new Array(100)).map(Number.prototype.valueOf,0);var a=this.getMemoryStore();Ext.MessageBox.prompt("Load Program","Please enter up to 100 digits:",function(e,f){f=f.replace(/[^0-9]/g,"");if(e==="ok"&&f.length>0){d=Math.min(100,f.length);for(c=0;c<d;++c){b[c]=parseInt(f[c])}this.onReset();a.loadProgram(b)}},this,true)},onLoadMachine:function(){Ext.create("BDC.lib.MachineLoadDialog")},onSaveText:function(){var a=this.getMemoryStore();var c="",b;for(b=0;b<100;++b){c=c+a.getCellValue(b).toString()}Ext.MessageBox.prompt("Save Program","Copy to clipboard:",Ext.emptyFn,this,true,c)},onSaveMachine:function(){var c,e;var d={};var a,b;Ext.MessageBox.prompt("Save Machine State","Please enter a name:",function(g,f){f=f.trim();if(g==="ok"&&f.length>0){c=this.getMachineStore();e=this.getMemoryStore();d.name=f;d.halted=c.getHalted();d.overflow_flag=c.getOverflow();d.reg_a=c.getACC();d.reg_pc=c.getPC();d.reg_ir=c.getIR();d.memory=[];for(b=0;b<100;++b){d.memory[b]=e.getCellValue(b)}Ext.Ajax.request({url:"./cgi-bin/save.rb?",method:"POST",params:{machine:Ext.JSON.encode(d)},success:function(){Ext.Msg.alert("Success","Machine saved successfully.")},failure:function(h){a=Ext.JSON.decode(h.responseText);Ext.Msg.alert("Save Error",a.result)}})}},this)},onProgramOne:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_ONE)},onProgramTwo:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_TWO)},onProgramThree:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_THREE)},onProgramFour:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_FOUR)},onProgramFive:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_FIVE)},onProgramSix:function(){this.loadProgram(BDC.lib.Programs.PROGRAM_SIX)},loadProgram:function(a){var b=this.getMachineStore();this.onReset();b.loadProgram(a)},loadMachine:function(b){var c,a;var e,d=this;c=this.getMachineStore();a=this.getMemoryStore();Ext.Ajax.request({url:"./cgi-bin/load.rb?",method:"GET",params:{name:b.get("name")},success:function(f){d.onReset();e=Ext.JSON.decode(f.responseText);c.setHalted(e.halted);c.setOverflow(e.overflow_flag);c.setACC(e.reg_a);c.setPC(e.reg_pc);c.setIR(e.reg_ir);a.loadProgram(e.memory)},failure:function(f){Ext.Msg.alert(f.responseText)}})},deleteMachine:function(c){var a,b=Ext.getStore("MachineList");Ext.Ajax.request({url:"./cgi-bin/delete.rb?",method:"DELETE",params:{name:c.get("name")},success:function(){b.reload()},failure:function(d){a=Ext.JSON.decode(d.responseText);Ext.Msg.alert("Delete Error",a.result)}})}});Ext.define("BDC.lib.Colors",{statics:{BLUE:"0000FF",GREEN:"00FF00",MAGENTA:"FF00FF"}});Ext.define("BDC.lib.Programs",{statics:{PROGRAM_ONE:[0,0,0,0,0,3,8,9,7,4,9,9,9,0,1,8,9,4,6,9,5,2,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,5,0,0,0],PROGRAM_TWO:[0,0,0,0,0,3,8,9,7,4,9,4,6,9,6,6,0,1,8,9,8,8,8,0,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,2,3,0,0,0],PROGRAM_THREE:[0,0,0,0,0,3,8,9,7,8,9,4,4,9,5,8,9,7,4,9,8,6,9,4,4,9,6,9,7,2,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,2,1,0,0],PROGRAM_FOUR:[0,0,0,1,0,3,4,9,7,6,9,7,4,9,4,6,9,5,8,9,7,6,9,4,4,9,7,8,9,4,6,9,7,6,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,3,0,0,0],PROGRAM_FIVE:[0,0,0,9,9,3,8,9,7,1,0,3,6,9,7,4,9,4,6,9,6,5,1,1,8,9,8,6,9,4,6,9,5,6,9,7,6,7,0,8,9,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,0,0,0,0],PROGRAM_SIX:[0,0,0,0,0,3,8,9,9,5,1,1,6,0,5,6,9,8,6,9,8,8,9,9,5,8,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,1,1,5,0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0]}});Ext.define("BDC.lib.Assembler",{uses:["BDC.lib.Character"],statics:{PROGRAM_SIZE:100,MNEMONICS:{halt:-1,j:0,jo:1,jno:2,loadi:3,load:4,add:5,sub:6,store:7,output:-2,inc:8,dec:9},TT_EMPTY:0,TT_ID:1,TT_NUMBER:2,TT_LABEL:3,TT_LBRACKET:4,TT_RBRACKET:5,PSEUDO_REGS:{q:80,r:82,s:84,t:86,u:88,v:90,w:92,x:94,y:96,z:98}},memory:[],symbols:{},refs:[],program:"",token:"",tt:undefined,i_index:0,o_index:0,line_no:0,initialize:function(){this.memory=Array.apply(null,new Array(this.self.PROGRAM_SIZE)).map(Number.prototype.valueOf,0);this.symbols={};this.refs=[];this.i_index=this.o_index=0;this.line_no=1;this.token=this.program="";this.tt=this.self.TT_EMPTY},constructor:function(){this.initialize()},assemble:function(a){this.initialize();this.program=a.toLowerCase();this.parse();this.resolve();return this.memory},parse:function(){this.i_index=0;while(true){this.getToken();switch(this.tt){case this.self.TT_EMPTY:return;case this.self.TT_LABEL:this.label();break;case this.self.TT_ID:this.instruction();break;default:this.syntax_error();break}}},resolve:function(){Ext.each(this.refs,function(b){var c,a;if((c=this.symbols[b.name])===undefined){a=Ext.String.format("can't find label {0}.",b.name);throw {error:a,line_no:b.line_no}}c=c-b.location-3;c=((c%this.self.PROGRAM_SIZE)+this.self.PROGRAM_SIZE)%this.self.PROGRAM_SIZE;this.memory[b.location]=c%10;this.memory[b.location+1]=Math.floor(c/10)},this)},getToken:function(){var b,a=this.program.length;this.tt=this.self.TT_EMPTY;for(this.token="";this.i_index<a;++this.i_index){b=this.program[this.i_index];switch(b){case" ":case"\t":case"\r":if(this.token.length){return}break;case":":if(this.token.length){this.i_index++;this.tt=this.self.TT_LABEL;return}else{this.syntax_error()}break;case";":this.comment();break;case"[":if(this.token.length){return}this.token=b;this.i_index++;this.tt=this.self.TT_LBRACKET;return;case"]":if(this.token.length){return}this.token=b;this.i_index++;this.tt=this.self.TT_RBRACKET;return;case"\n":if(this.token.length){return}this.line_no++;break;default:if(BDC.lib.Character.isdigit(b)){if(this.tt===this.self.TT_EMPTY){this.tt=this.self.TT_NUMBER}this.token+=b;continue}else{if(BDC.lib.Character.isalpha(b)){this.tt=this.self.TT_ID;this.token+=b;continue}else{this.syntax_error()}}break}}},instruction:function(){var a;if(this.token.length===0){this.syntax_error()}if((a=this.self.MNEMONICS[this.token])===undefined){this.syntax_error()}this.assemble_instr(a)},assemble_instr:function(a){switch(a){case this.self.MNEMONICS.halt:this.halt();break;case this.self.MNEMONICS.j:this.jump();break;case this.self.MNEMONICS.jo:this.jo();break;case this.self.MNEMONICS.jno:this.jno();break;case this.self.MNEMONICS.loadi:this.loadi();break;case this.self.MNEMONICS.load:this.load();break;case this.self.MNEMONICS.add:this.add();break;case this.self.MNEMONICS.sub:this.sub();break;case this.self.MNEMONICS.store:this.store();break;case this.self.MNEMONICS.output:this.output();break;case this.self.MNEMONICS.inc:this.inc();break;case this.self.MNEMONICS.dec:this.dec();break}},assemble_val:function(a){this.memory[this.o_index++]=a%10;this.memory[this.o_index++]=Math.floor(a/10)},halt:function(){this.assemble_val(0);this.memory[this.o_index++]=this.self.MNEMONICS.j},jump:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.j},jo:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.jo},jno:function(){var a=this.getTarget();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.jno},load:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.load},loadi:function(){var a=this.getImmediate();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.loadi},store:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.store},output:function(){this.assemble_val(0);this.memory[this.o_index++]=this.self.MNEMONICS.store},add:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.add},sub:function(){var a=this.getMemory();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.sub},inc:function(){var a=this.getMemAcc();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.inc},dec:function(){var a=this.getMemAcc();this.assemble_val(a);this.memory[this.o_index++]=this.self.MNEMONICS.dec},getImmediate:function(){this.getToken();if(this.tt!==this.self.TT_NUMBER){this.syntax_error()}return this.parseValue()},parseValue:function(){var a=parseInt(this.token,10);if(isNaN(a)){this.syntax_error()}if(0>a||a>99){this.error("number out of range.")}return a},getMemory:function(){this.getToken();return this.getMemValue()},getMemValue:function(){var a;if(this.tt===this.self.TT_LBRACKET){if((a=this.getIndirect())===false){this.syntax_error()}return a}if(this.tt!==this.self.TT_NUMBER&&this.tt!==this.self.TT_ID){this.syntax_error()}if(this.tt===this.self.TT_NUMBER){return this.parseValue()}if((a=this.self.PSEUDO_REGS[this.token])===undefined){this.error("undefined symbol")}return a},getMemAcc:function(){this.getToken();if(this.tt===this.self.TT_ID&&this.token==="a"){return 0}return this.getMemValue()},getIndirect:function(){var b,a;this.getToken();if(this.tt!==this.self.TT_ID){return false}a=this.token;this.getToken();if(this.tt!==this.self.TT_RBRACKET){return false}if(a.match(/^[w-z]$/)===null){return false}if((b=this.self.PSEUDO_REGS[a])===undefined){return false}b=b-this.self.PSEUDO_REGS.v;return b},getTarget:function(){var a;this.getToken();if(this.tt!==this.self.TT_NUMBER&&this.tt!==this.self.TT_ID){this.syntax_error()}if(this.tt===this.self.TT_NUMBER){a=this.parseValue();a=this.getOffset(a);return a}if((a=this.symbols[this.token])!==undefined){a=this.getOffset(a);return a}this.refs.push({name:this.token,location:this.o_index,line_no:this.line_no});return 0},getOffset:function(a){a=((this.self.PROGRAM_SIZE-this.o_index)+a)-3;a=((a%this.self.PROGRAM_SIZE)+this.self.PROGRAM_SIZE)%this.self.PROGRAM_SIZE;return a},comment:function(){var b,a=this.program.length;for(;this.i_index<a;++this.i_index){b=this.program[this.i_index];if(b==="\n"){this.i_index--;return}}},label:function(){if(this.token.length===0){this.syntax_error()}if(this.symbols[this.token]!==undefined){this.error("label already defined.")}if(this.self.PSEUDO_REGS[this.token]!==undefined){this.error("illegal label.")}this.symbols[this.token]=this.o_index},syntax_error:function(){this.error("syntax error.")},error:function(a){throw {error:a,line_no:this.line_no}}});Ext.define("BDC.lib.AssemblerEditor",{extend:"Ext.panel.Panel",requires:"BDC.lib.Assembler",itemId:"bdc-assembler",title:"BDC Assembler",renderTo:"bdc-assembler",iconCls:"assemble-icon",autoShow:true,closable:true,width:600,height:375,collapsible:true,floating:true,draggable:true,resizable:true,statics:{show:function(){if(Ext.ComponentQuery.query("panel[itemId=bdc-assembler]")[0]){return}return Ext.create("BDC.lib.AssemblerEditor")}},dockedItems:[{xtype:"toolbar",items:[{xtype:"button",tooltip:{text:"Assemble Source Code",title:"Assemble"},text:"Assemble Source Code",iconCls:"assemble-icon",focusCls:"",id:"assembleButton"}]}],items:[{xtype:"textarea",itemId:"assembler-text",width:600,height:375,fieldStyle:{fontFamily:"courier new",fontSize:"14px"},validationEvent:false,enableKeyEvents:true,listeners:{keydown:function(b,a){if(a.getKey()===a.TAB){a.stopEvent();b.insertTab()}}},insertTab:function(){var b=this.inputEl.dom;if(b.setSelectionRange){var a=b.value.substring(0,b.selectionStart)+"\t";var c=a.length;b.value=a+b.value.substring(b.selectionEnd,b.value.length);b.setSelectionRange(c,c)}else{if(document.selection){document.selection.createRange().text="\t"}}}}],assembler:Ext.create("BDC.lib.Assembler"),assemble:function(){var b=this.getComponent("assembler-text");var a=b.getValue();return this.assembler.assemble(a)}});Ext.define("BDC.lib.Disassembler",{extend:"Ext.grid.Panel",itemId:"bdc-disassembler",title:"BDC Disassembler",renderTo:"bdc-disassembler",iconCls:"disassemble-icon",autoShow:true,closable:true,width:320,height:400,collapsible:true,floating:true,draggable:true,resizable:true,statics:{show:function(){if(Ext.ComponentQuery.query("panel[itemId=bdc-disassembler]")[0]){return}return Ext.create("BDC.lib.Disassembler")}},viewConfig:{stripeRows:true,enableTextSelection:true},scroll:"vertical",sortableColumns:false,rowLines:false,columns:[{text:"Location",dataIndex:"location",flex:1,draggable:false,menuDisabled:true,sortable:false,resizable:true,renderer:function(c){c=c%100;var a=Math.floor(c/10);var b=c%10;return Ext.String.format("{0}{1}",a,b)}},{text:"Opcode / Operands",dataIndex:"ir",flex:2,draggable:false,menuDisabled:true,sortable:false,resizable:true,renderer:function(a){return Ext.String.format("{0} {1} {2}",a[2],a[1],a[0])}},{text:"Mnemonic Instruction",dataIndex:"instruction",flex:2,draggable:false,menuDisabled:true,sortable:false,resizable:true}],initComponent:function(){this.store=Ext.getStore("Disassembly");this.callParent(arguments)}});Ext.define("BDC.lib.MachineLoadDialog",{extend:"Ext.window.Window",iconCls:"database-icon",id:"loadDialog",modal:true,autoShow:true,width:400,height:300,shadow:true,resizable:false,buttonAlign:"right",title:"Load Machine",layout:"fit",items:[{xtype:"gridpanel",itemId:"machinesPanel",autoHeight:true,columns:[{text:"Name",flex:2,dataIndex:"name",draggable:false,menuDisabled:true,sortable:true,resizable:true},{text:"Date",xtype:"datecolumn",format:"m-d h:i a",flex:1,dataIndex:"date",draggable:false,menuDisabled:true,sortable:true,resizable:true}],listeners:{selectionchange:{fn:function(a,b){Ext.ComponentQuery.query("button[itemId=okButton]")[0].setDisabled(!b.length)},scope:this},itemcontextmenu:function(c,b,f,d,e){var g=c.up().up().down(".menu");var a=e.getXY();e.stopEvent();g.showAt(a)}}},{xtype:"menu",items:[{text:"Delete Machine",iconCls:"delete-icon",handler:function(){var a,b=Ext.ComponentQuery.query("#machinesPanel")[0];if(b.getSelectionModel().hasSelection()){a=b.getSelectionModel().getSelection()[0];b.fireEvent("deleteMachine",a)}}}]}],buttons:[{xtype:"button",text:"OK",disabled:true,itemId:"okButton",handler:function(){var d=this,a,e=d.up(".window"),c;var b=Ext.ComponentQuery.query("#machinesPanel")[0];if(b.getSelectionModel().hasSelection()){a=b.getSelectionModel().getSelection()[0];e.fireEvent("loadMachine",a);e.close()}}},{xtype:"button",text:"Cancel",handler:function(){this.up(".window").close()}}],initComponent:function(){var a,b=Ext.getStore("MachineList");this.callParent(arguments);a=this.getComponent("machinesPanel");a.reconfigure(b);b.load()}});Ext.define("BDC.lib.Frame",{extend:"Ext.panel.Panel",alias:"bdc-frame",itemId:"bdc-frame",title:"Basic Decimal Computer",renderTo:"bdc-app",iconCls:"cpu-icon",width:625,height:375,layout:"fit",items:[{xtype:"bdc-view"}],initComponent:function(){Ext.QuickTips.init();this.callParent(arguments)}});Ext.define("BDC.lib.Character",{statics:{isalpha:function(a){return(((a>="a")&&(a<="z"))||((a>="A")&&(a<="Z")))},isdigit:function(a){return((a>="0")&&(a<="9"))},isalnum:function(a){return(this.isalpha(a)||this.isdigit(a))}}});Ext.application({name:"BDC",appFolder:"app",controllers:["Controller"],uses:"BDC.lib.Frame",launch:function(){Ext.create("bdc-frame").show()}});$(function(){$("#tabs").tabs({activate:function(a,b){var c;if(b.newTab.index()===1){c=Ext.ComponentQuery.query("#bdc-frame")[0];if(c){c.doLayout()}}}})});
